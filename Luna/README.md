Depending:

```
common.h
value.h
chunk.h
table.h
scanner.h
object.h
memory.h
vm.h
timeline.h
value.c
chunk.c
memory.c
table.c
object.c
scanner.c
compiler.h
compiler.c
vm.c
video.h
bind_video.c
video_export.c
video_player.c
video_probe.c
timeline.c
compositor.h
compositor.c
main.c
```

### âš ï¸ å‘ç°çš„æŠ€æœ¯ä¸ä¸€è‡´ (Technical Inconsistencies)

**1. vm ä¸Šä¸‹æ–‡ç®¡ç†çš„ç²¾ç¥åˆ†è£‚ (schizophrenic context)**
*   **ç°è±¡**: `src/vm/vm.h` ä¸­çš„ api è®¾è®¡ä¸ºæ”¯æŒå¤šå®ä¾‹ï¼ˆå¦‚ `interpret(vm* vm, ...)` æ¥æ”¶æŒ‡é’ˆï¼‰ï¼Œçœ‹èµ·æ¥å¾ˆç°ä»£ã€‚
*   **å†²çª**: ä½† `src/vm/object.c`ã€`src/vm/memory.c` å’Œ `src/binding/bind_video.c` å†…éƒ¨å´ç¡¬ç¼–ç ä½¿ç”¨äº† `extern vm vm;`ï¼ˆå…¨å±€å˜é‡ï¼‰ã€‚
*   **åæœ**: ç›®å‰è™½ç„¶ api çœ‹ç€åƒé¢å‘å¯¹è±¡çš„ï¼Œä½†å®é™…ä¸Šåº•å±‚è¿˜æ˜¯å•ä¾‹æ¨¡å¼ã€‚å¦‚æœå°è¯•åˆ›å»ºä¸¤ä¸ª vmï¼Œç¨‹åºçŠ¶æ€ä¼šä¹±å¥—ã€‚

**2. å†…å­˜åˆ†é…å™¨çš„å‰²è£‚ (allocator split)**
*   **ç°è±¡**: vm å±‚ (`vm/`) ä¸¥æ ¼ä½¿ç”¨ `reallocate` å‡½æ•°ï¼Œè¿™ä¸ä»…è´Ÿè´£åˆ†é…ï¼Œè¿˜è´Ÿè´£**gc å†…å­˜ç»Ÿè®¡**ã€‚
*   **å†²çª**: å¼•æ“å±‚ (`engine/`)ï¼Œå¦‚ `compositor.c` å’Œ `timeline.c`ï¼Œç›´æ¥ä½¿ç”¨äº†æ ‡å‡†åº“çš„ `malloc/calloc/free`ã€‚
*   **åæœ**: è§†é¢‘å¤„ç†æ¶ˆè€—äº†å¤§é‡å†…å­˜ï¼ˆå¦‚å¸§ç¼“å†²åŒºã€è§£ç å™¨ï¼‰ï¼Œä½† vm çš„ gc ç³»ç»Ÿå¯¹æ­¤ä¸€æ— æ‰€çŸ¥ã€‚è¿™ä¼šå¯¼è‡´ vm ä»¥ä¸ºå†…å­˜å¾ˆç©ºé—²è€Œä¸è§¦å‘ gcï¼Œæœ€ç»ˆå¯¼è‡´ç‰©ç†å†…å­˜è€—å°½è¢«ç³»ç»Ÿæ€æ‰ã€‚

**3. åŸºç¡€ç±»å‹å®šä¹‰çš„æ··ä¹± (type chaos)**
*   **ç°è±¡**: `common.h` ç²¾å¿ƒåœ°å®šä¹‰äº†è·¨å¹³å°çš„ `u8`, `u32`, `i32`, `f32`ã€‚
*   **å†²çª**: `engine/` ç›®å½•ä¸‹çš„ä»£ç ï¼ˆç‰¹åˆ«æ˜¯ `compositor.c` å’Œ `video_player.c`ï¼‰æ··åˆä½¿ç”¨äº†åŸç”Ÿ c ç±»å‹ `int`, `unsigned char`, `uint8_t`ã€‚
*   **åæœ**: ä»£ç é£æ ¼ä¸ç»Ÿä¸€ï¼Œä¸”åœ¨ä¸åŒç¼–è¯‘å™¨ä¸‹çš„ä½å®½ä¿è¯å¯èƒ½å¤±æ•ˆã€‚

**4. opengl ä¸Šä¸‹æ–‡çš„é‡å¤åˆå§‹åŒ– (context collision)**
*   **ç°è±¡**: `main.c` åˆå§‹åŒ–äº† sdl å’Œ opengl (glad)ã€‚
*   **å†²çª**: `video_player.c` ä¸­çš„ `play_video_clip` å‡½æ•°**å†æ¬¡**è°ƒç”¨äº† `sdl_init` å¹¶åˆ›å»ºäº†**æ–°çš„**çª—å£å’Œ gl contextã€‚
*   **åæœ**: è™½ç„¶ç›®å‰ `main.c` è¿˜æ²¡è°ƒç”¨ `play_video_clip`ï¼Œä½†å¦‚æœæœªæ¥ä½œä¸ºâ€œé¢„è§ˆå­çª—å£â€è°ƒç”¨å®ƒï¼Œä¼šå¯¼è‡´ glad çš„å‡½æ•°æŒ‡é’ˆçŠ¶æ€é”™ä¹±ï¼ˆglad æ˜¯è¿›ç¨‹å…¨å±€çš„ï¼‰ï¼Œå¯èƒ½å¼•å‘æ¸²æŸ“å´©æºƒã€‚

**5. èµ„æºå¥æŸ„çš„æµªè´¹ (resource duplication)**
*   **ç°è±¡**: `compositor.c` ä¸ºæ¯ä¸ª clip å®ä¾‹åˆ›å»ºä¸€ä¸ª `clipdecoder`ã€‚
*   **å†²çª**: å¦‚æœæ—¶é—´è½´ä¸Šæœ‰ 50 ä¸ªåˆ‡ç‰‡éƒ½æ¥è‡ªåŒä¸€ä¸ª `video.mp4`ï¼Œå¼•æ“ä¼šæ‰“å¼€è¿™ä¸ªæ–‡ä»¶ 50 æ¬¡ (`avformat_open_input`)ã€‚
*   **åæœ**: ææ˜“è§¦å‘ç”Ÿäº§ç¯å¢ƒçš„ "too many open files" é”™è¯¯ï¼Œä¸”æµªè´¹å¤§é‡å†…å­˜ã€‚

---

### ğŸ“„ æ›´æ–°åçš„é¡¹ç›®è§„åˆ’æ–‡æ¡£ (v0.6.0)

ä»¥ä¸‹æ˜¯æ•´åˆäº†ä¸Šè¿°å‘ç°çš„æ›´æ–°ç‰ˆæ–‡æ¡£ã€‚

# ğŸŒ™ Luna Video Engine - å¼€å‘è§„åˆ’ä¸æ¶æ„æ–‡æ¡£

**ç‰ˆæœ¬**: 0.6.0 (Beta - OpenGL Integration)
**æ—¥æœŸ**: 2024-05
**çŠ¶æ€**: æ ¸å¿ƒæ¸²æŸ“ç®¡çº¿å·²è¿ç§»è‡³ GPUï¼Œæ”¯æŒ Alpha æ··åˆä¸å…¨å·¥ç¨‹å¯¼å‡ºã€‚

---

## 1. å½“å‰å®Œæˆæƒ…å†µ (Current Status)

### âœ… å·²å®ŒæˆåŠŸèƒ½
1.  **è„šæœ¬è™šæ‹Ÿæœº (VM)**: å®Œæ•´çš„ç¼–è¯‘ã€æ‰§è¡Œã€GC ç¯å¢ƒï¼ˆæ”¯æŒ NaN Boxingï¼‰ã€‚
2.  **æ•°æ®ç»“æ„**: å¤šè½¨é“æ—¶é—´è½´ (Timeline)ï¼ŒåŸºäºåŠ¨æ€æ•°ç»„ä¼˜åŒ–ã€‚
3.  **æ¸²æŸ“ç®¡çº¿ (OpenGL)**:
    *   åŸºäº Shader çš„ YUV420P -> RGB è½¬æ¢ã€‚
    *   **Alpha Blending**: æ”¯æŒå›¾å±‚å åŠ ä¸åŠé€æ˜ã€‚
    *   ç¡¬ä»¶åŠ é€Ÿçš„ Transform (ä½ç§»ã€ç¼©æ”¾)ã€‚
4.  **å·¥ç¨‹å¯¼å‡º**: æ”¯æŒå°†æ¸²æŸ“ç»“æœç¼–ç ä¸º H.264 `.mp4` æ–‡ä»¶ã€‚
5.  **çƒ­é‡è½½ (Hot-Reload)**: ç›‘å¬è„šæœ¬æ–‡ä»¶ä¿®æ”¹ï¼Œè‡ªåŠ¨é‡Šæ”¾æ—§èµ„æºå¹¶é‡ç¼–è¯‘ã€‚

### ğŸš§ å¾…è§£å†³çš„æŠ€æœ¯å€ºåŠ¡ (Refactoring Needed)
**è¿™æ˜¯å½“å‰çš„é¦–è¦ä»»åŠ¡ï¼ˆv0.6.1 ç›®æ ‡ï¼‰ã€‚** å¿…é¡»åœ¨æ·»åŠ å¤æ‚æ–°åŠŸèƒ½å‰ç»Ÿä¸€åº•å±‚è®¾æ–½ã€‚

#### A. å†…å­˜ç®¡ç†ç»Ÿä¸€ (Critical)
ç›®å‰ Engine å±‚ç»•è¿‡äº† VM çš„ GC ç»Ÿè®¡ï¼Œè¿™æ˜¯å±é™©çš„ã€‚
*   **ç›®æ ‡**: æ‰€æœ‰å †å†…å­˜åˆ†é…å¿…é¡»ç»è¿‡ `vm/memory.h` ä¸­çš„ `reallocate`ã€‚
*   **æ‰§è¡Œ**:
    *   ä¿®æ”¹ `src/engine/compositor.c`: å°† `malloc/calloc` æ›¿æ¢ä¸º `ALLOCATE` å®ã€‚
    *   ä¿®æ”¹ `src/engine/timeline.c`: è½¨é“å’Œ Clip çš„æ•°ç»„æ‰©å®¹ä½¿ç”¨ `GROW_ARRAY` å®ã€‚
    *   *éš¾ç‚¹*: Engine å±‚éœ€è¦è®¿é—® `VM` å®ä¾‹ã€‚æš‚æ—¶æ–¹æ¡ˆæ˜¯åœ¨ `common.h` æˆ–å¯¹åº” `.c` ä¸­å¼•å…¥ `extern VM vm;`ï¼Œé•¿æœŸæ–¹æ¡ˆæ˜¯é‡æ„ Engine åˆå§‹åŒ–å‡½æ•°ä»¥æ¥æ”¶ Contextã€‚

#### B. ç±»å‹å®šä¹‰æ ‡å‡†åŒ–
*   **ç›®æ ‡**: æ¶ˆé™¤ä»£ç åº“ä¸­çš„ `int`, `unsigned char`, `uint8_t`ã€‚
*   **æ‰§è¡Œ**:
    *   å…¨å±€æœç´¢æ›¿æ¢ä¸º `common.h` ä¸­çš„ `i32`, `u8`, `u32`, `f32`ã€‚
    *   æ¶‰åŠæ–‡ä»¶: `compositor.c`, `video_player.c`, `video_export.c`, `timeline_export.c`.

#### C. ä¸Šä¸‹æ–‡ç®¡ç†ä¿®å¤
*   **ç›®æ ‡**: æ˜ç¡® `video_player.c` çš„å®šä½ã€‚
*   **æ‰§è¡Œ**:
    *   å¦‚æœå®ƒä»…ç”¨äºè°ƒè¯• CLIï¼Œä¿æŒåŸæ ·ä½†å¢åŠ æ³¨é‡Šã€‚
    *   å¦‚æœå®ƒæ˜¯å¼•æ“çš„ä¸€éƒ¨åˆ†ï¼Œ**ç§»é™¤**å…¶å†…éƒ¨çš„ `SDL_Init` å’Œ `SDL_CreateWindow`ï¼Œæ”¹ä¸ºæ¥æ”¶ç°æœ‰çš„ Framebuffer æˆ– Texture è¿›è¡Œæ¸²æŸ“ã€‚

---

## 2. æœªæ¥åŠŸèƒ½è§„åˆ’ (Roadmap)

ä»¥ä¸‹åŠŸèƒ½æŒ‰ä¼˜å…ˆçº§æ’åºã€‚**æœ€å°åŒ–å‚è€ƒæ–‡ä»¶åˆ—è¡¨**æ—¨åœ¨å¸®åŠ©å¼€å‘è€…èšç„¦ä¿®æ”¹ç‚¹ã€‚

### ğŸš€ é˜¶æ®µä¸€ï¼šé¢„è§ˆä½“éªŒå¢å¼º (Preview Enhancements)

#### 1. é¢„è§ˆæ—¶é—´èŒƒå›´é€‰æ‹© (Loop Range)
**æè¿°**: å…è®¸è„šæœ¬è®¾ç½®å¾ªç¯æ’­æ”¾åŒºé—´ï¼Œæ–¹ä¾¿è°ƒè¯•ç‰¹å®šç‰‡æ®µã€‚
*   **è„šæœ¬ API**: `setPreviewRange(start, end)`
*   **ğŸ› ï¸ æ¶‰åŠæ–‡ä»¶** :
    1.  `src/engine/timeline.h`: `Timeline` ç»“æ„ä½“å¢åŠ  `double loop_start, loop_end;`ã€‚
    2.  `src/binding/bind_video.c`: å®ç° `nativeSetPreviewRange` ç»‘å®šã€‚
    3.  `src/main.c`: **ä¸»å¾ªç¯é€»è¾‘**ã€‚åœ¨ `current_time` ç´¯åŠ åï¼Œå¢åŠ è¾¹ç•Œæ£€æŸ¥ï¼š`if (time > loop_end) time = loop_start;`ã€‚

#### 2. é¢„è§ˆè§†å£æ§åˆ¶ (Viewport Control)
**æè¿°**: æ”¯æŒç¼©æ”¾é¢„è§ˆçª—å£å¤§å°ï¼Œé€‚åº”ä¸åŒåˆ†è¾¨ç‡å±å¹•ã€‚
*   **è„šæœ¬ API**: `setPreviewScale(0.5)`
*   **ğŸ› ï¸ æ¶‰åŠæ–‡ä»¶**:
    1.  `src/main.c`:
        *   ä¿®æ”¹çª—å£åˆ›å»ºå°ºå¯¸é€»è¾‘ `win_w = tl->width * scale`ã€‚
        *   ä¿®æ”¹ `compositor_blit_to_screen` è°ƒç”¨å‚æ•°ï¼Œç¡®ä¿ Blit åˆ°å±å¹•æ—¶ä¿æŒå®½é«˜æ¯”æˆ–å¡«å……ã€‚
    2.  `src/engine/compositor.c`: ç¡®ä¿ `glViewport` åœ¨ Blit é˜¶æ®µæ­£ç¡®è®¾ç½®ã€‚

---

### ğŸ”Š é˜¶æ®µäºŒï¼šéŸ³é¢‘ç³»ç»Ÿ (Audio System)

#### 1. åŸºç¡€æ··éŸ³ (Basic Mixing)
**æè¿°**: å®ç°è§†é¢‘éŸ³é¢‘æµçš„è§£ç ä¸å åŠ ã€‚
*   **ğŸ› ï¸ æ¶‰åŠæ–‡ä»¶**:
    1.  `src/engine/timeline.h`: `TimelineClip` å¢åŠ éŸ³é¢‘æµç´¢å¼•æ ‡è®°ã€‚
    2.  `src/engine/compositor.c`:
        *   `ClipDecoder` ç»“æ„ä½“å¢åŠ  `AVCodecContext* audio_dec_ctx`ã€‚
        *   æ–°å¢ `compositor_mix_audio(time, out_buffer, sample_count)` å‡½æ•°ã€‚
    3.  `src/main.c`: å¯ç”¨ `SDL_Init(SDL_INIT_AUDIO)`ï¼Œé…ç½® `SDL_AudioSpec` å›è°ƒå‡½æ•°æŒ‡å‘æ··éŸ³å™¨ã€‚

---

### ğŸ¨ é˜¶æ®µä¸‰ï¼šåŠ¨ç”»ç³»ç»Ÿ (Animation System)

#### 1. å±æ€§å…³é”®å¸§ (Property Keyframes)
**æè¿°**: è®© `x`, `y`, `opacity`, `scale` éšæ—¶é—´å˜åŒ–ã€‚
*   **è„šæœ¬ API**: `animate(clip, "opacity", 0.0, 1.0, 0, 2.0)` (ä»0åˆ°1ï¼Œè€—æ—¶2ç§’)
*   **æ¶æ„å˜æ›´**: `TimelineClip` ä¸­çš„ `Transform` å±æ€§éœ€è¦ä» `float` å˜ä¸º `KeyframeTrack` ç»“æ„ã€‚
*   **ğŸ› ï¸ æ¶‰åŠæ–‡ä»¶**:
    1.  `src/engine/timeline.h`: å®šä¹‰ `Keyframe` å’Œ `PropertyTrack` ç»“æ„ã€‚ä¿®æ”¹ `Transform` ç»“æ„ã€‚
    2.  `src/engine/timeline.c`: å®ç°å…³é”®å¸§çš„æ’å…¥ä¸äºŒåˆ†æŸ¥æ‰¾é€»è¾‘ã€‚
    3.  `src/engine/compositor.c`: **æ¸²æŸ“çƒ­è·¯å¾„ä¿®æ”¹**ã€‚åœ¨ `compositor_render` å¾ªç¯ä¸­ï¼Œä¸å†ç›´æ¥è¯»å– `clip->transform.x`ï¼Œè€Œæ˜¯è°ƒç”¨ `get_property_value(clip->transform.x_track, time)` è®¡ç®—å½“å‰å€¼ã€‚
